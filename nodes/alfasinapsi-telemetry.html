<script type="text/html" data-template-name="alfasinapsi-telemetry">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Nome</label>
    <input type="text" id="node-input-name" placeholder="telemetria">
  </div>
  <div class="form-row">
    <label for="node-input-device"><i class="fa fa-plug"></i> Dispositivo</label>
    <input type="text" id="node-input-device">
  </div>
  <div class="form-row">
    <label for="node-input-pollInterval"><i class="fa fa-clock-o"></i> Poll (ms)</label>
    <input type="number" id="node-input-pollInterval" placeholder="2000">
  </div>
  <div class="form-row">
    <label for="node-input-sendOnChange"><i class="fa fa-filter"></i> Solo se cambia</label>
    <input type="checkbox" id="node-input-sendOnChange" style="width:auto;">
  </div>
  <div class="form-row">
    <label for="node-input-compatibility"><i class="fa fa-puzzle-piece"></i> Compatibilita</label>
    <select id="node-input-compatibility">
      <option value="telemetry">Telemetria</option>
      <option value="knxLoadControlPin">KNX Load Control PIN</option>
    </select>
  </div>
</script>

<script type="text/html" data-help-name="alfasinapsi-telemetry">
  <p><b>Telemetria Sinapsi Alfa</b> legge i dati da Sinapsi Alfa e invia messaggi dal suo unico output, in base alla compatibilita selezionata.</p>

  <h3>Uscite</h3>
  <p>Questo nodo ha 1 uscita. In base alla <i>Compatibilita</i> selezionata, cambia il formato dei messaggi emessi.</p>
  <ul>
    <li><b>Telemetria</b>: invia il messaggio principale con <code>msg.payload</code> (semplificato) e <code>msg.insight</code> (tecnico).</li>
    <li><b>KNX Load Control PIN</b>: invia un telegramma compatibile con l'ingresso del nodo KNX Load Control: <code>msg.shedding</code> = <code>shed</code>/<code>unshed</code> ogni 10s.</li>
  </ul>

  <h3>Output: Telemetria</h3>
  <dl class="message-properties">
    <dt>msg.topic <span class="property-type">string</span></dt>
    <dd><code>alfasinapsi/telemetry</code></dd>

    <dt>msg.payload <span class="property-type">object</span></dt>
    <dd>Valori semplificati per l'uso quotidiano (potenza/energia/fascia tariffaria/avviso distacco).</dd>

    <dt>msg.insight <span class="property-type">object</span></dt>
    <dd>Dettagli tecnici (telemetria completa decodificata + meta informazioni).</dd>
  </dl>

  <h3>msg.payload (semplificato)</h3>
  <ul>
    <li><code>payload.power.importkW</code>, <code>payload.power.exportkW</code>, <code>payload.power.productionkW</code></li>
    <li><code>payload.energy.importTotalkWh</code>, <code>payload.energy.exportTotalkWh</code>, <code>payload.energy.productionTotalkWh</code></li>
    <li><code>payload.tariffBand</code></li>
    <li><code>payload.cutoff.hasWarning</code>, <code>payload.cutoff.atIso</code></li>
  </ul>

  <h3>Terminologia</h3>
  <ul>
    <li><b>Import</b>: potenza/energia prelevata dalla rete (consumi piu di quanto produci).</li>
    <li><b>Export</b>: potenza/energia immessa in rete (produci piu di quanto consumi).</li>
    <li><b>Production</b>: potenza/energia prodotta (per esempio da fotovoltaico).</li>
  </ul>

  <h3>msg.insight (tecnico)</h3>
  <ul>
    <li><code>insight.telemetry</code>: telemetria completa decodificata (include campi extra come fasce di ieri, medie di quarto d'ora, ecc.)</li>
    <li><code>insight.meta</code>: timestamp, codice funzione, modalita lettura</li>
    <li><code>insight.device</code>: dettagli profilo connessione</li>
  </ul>

  <h3>Output: KNX Load Control PIN</h3>
  <p>Ogni 10 secondi invia <code>shed</code> se la telemetria segnala un distacco imminente, altrimenti <code>unshed</code>.</p>
  <dl class="message-properties">
    <dt>msg.topic <span class="property-type">string</span></dt>
    <dd><code>alfasinapsi/telemetry/knx-load-control-pin</code></dd>

    <dt>msg.payload <span class="property-type">string</span></dt>
    <dd><code>shed</code> oppure <code>unshed</code></dd>

    <dt>msg.shedding <span class="property-type">string</span></dt>
    <dd><code>shed</code> oppure <code>unshed</code> (per compatibilita con KNX Load Control)</dd>
  </dl>

  <h3>Configurazione</h3>
  <dl class="message-properties">
    <dt>Dispositivo <span class="property-type">alfasinapsi-device</span></dt>
    <dd>Indirizzo IP Sinapsi (impostazioni di comunicazione fisse).</dd>

    <dt>Poll (ms) <span class="property-type">number</span></dt>
    <dd>Ogni quanto il nodo legge i dati.</dd>

    <dt>Solo se cambia <span class="property-type">boolean</span></dt>
    <dd>Se abilitato, invia messaggi solo quando cambia il payload.</dd>

    <dt>Compatibilita <span class="property-type">telemetry | knxLoadControlPin</span></dt>
    <dd>
      <ul>
        <li><code>Telemetria</code>: emette la telemetria (rispetta <i>Poll</i> e <i>Solo se cambia</i>).</li>
        <li><code>KNX Load Control PIN</code>: emette <code>shed</code>/<code>unshed</code> ogni 10s (in questa modalita <i>Solo se cambia</i> non si applica).</li>
      </ul>
      Nota: in modalita <code>KNX Load Control PIN</code> il polling interno e' limitato a 10s (anche se imposti un Poll piu alto).
    </dd>
  </dl>

  <h3>Dettagli tecnici</h3>
  <ul>
    <li>Codice funzione: <code>3</code> (lettura registri holding)</li>
  </ul>

  <h3>Risoluzione problemi</h3>
  <ul>
    <li>Se i valori restano a 0, verifica l'indirizzo IP e che la porta 502 sia raggiungibile da Node-RED.</li>
    <li>Se vedi errori di timeout, assicurati che nessun altro sistema sia connesso al dispositivo nello stesso momento (spesso e' consentita una sola connessione alla volta).</li>
  </ul>
</script>

<script type="text/javascript">
  (function () {
    RED.nodes.registerType('alfasinapsi-telemetry', {
      category: 'energy',
      color: '#00BAFF',
      defaults: {
        name: { value: "" },
        device: { value: "", type: "alfasinapsi-device", required: true },
        pollInterval: { value: 2000, validate: RED.validators.number() },
        sendOnChange: { value: false },
        compatibility: { value: "telemetry" }
      },
      inputs: 0,
      outputs: 1,
      outputLabels: function () {
        return (this.compatibility === "knxLoadControlPin") ? "KNX Load Control PIN" : "telemetria";
      },
      icon: "font-awesome/fa-bolt",
      label: function () { return this.name || "alfasinapsi telemetria"; }
    });
  })();
</script>
