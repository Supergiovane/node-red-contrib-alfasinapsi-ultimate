<script type="text/html" data-template-name="alfasinapsi-telemetry">
  <div class="form-row">
    <label><i class="fa fa-youtube-play" style="color:#ff0000;"></i> Video</label>
    <a href="https://youtu.be/R-7PZv3iJ2s" target="_blank" rel="noopener noreferrer">Guarda su YouTube</a>
  </div>

  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Nome</label>
    <input type="text" id="node-input-name" placeholder="telemetria">
  </div>
  <div class="form-row">
    <label for="node-input-device"><i class="fa fa-plug"></i> Dispositivo</label>
    <input type="text" id="node-input-device">
  </div>
  <div class="form-row">
    <label for="node-input-pollInterval"><i class="fa fa-clock-o"></i> Poll (ms)</label>
    <input type="number" id="node-input-pollInterval" placeholder="2000">
  </div>
  <div class="form-row">
    <label for="node-input-sendOnChange"><i class="fa fa-filter"></i> Solo se cambia</label>
    <input type="checkbox" id="node-input-sendOnChange" style="width:auto;">
  </div>
  <div class="form-row">
    <label for="node-input-compatibility"><i class="fa fa-puzzle-piece"></i> Compatibilita</label>
    <select id="node-input-compatibility">
      <option value="telemetry">Telemetria</option>
      <option value="knxLoadControlPin">KNX Load Control PIN</option>
    </select>
  </div>
</script>

<script type="text/html" data-help-name="alfasinapsi-telemetry">
	  <p><b>Telemetria Sinapsi Alfa</b> legge i dati da Sinapsi Alfa e invia messaggi dal suo unico output, in base alla compatibilita selezionata.</p>

	  <h3>Video YouTube</h3>
	  <p><a href="https://youtu.be/R-7PZv3iJ2s" target="_blank" rel="noopener noreferrer">Guarda il video: configurazione e utilizzo</a></p>

	  <h3>Importante: frequenza (Poll)</h3>
	  <p>
	    Il campo <b>Poll (ms)</b> influenza direttamente ogni automazione collegata a questo nodo.
	    Per esempio, se colleghi l'output al nodo <code>alfasinapsi-load-controller</code>, la velocita con cui aumenta/diminuisce lo <i>shedding stage</i>
	    dipende dalla frequenza con cui arrivano i messaggi.
	  </p>

	  <h3>Uscite</h3>
	  <p>Questo nodo ha 1 uscita. In base alla <i>Compatibilita</i> selezionata, cambia il formato dei messaggi emessi.</p>
	  <ul>
	    <li><b>Telemetria</b>: invia il messaggio principale con <code>msg.payload</code> (semplificato) e <code>msg.insight</code> (tecnico).</li>
	    <li><b>KNX Load Control PIN</b>: invia un telegramma compatibile con l'ingresso del nodo KNX Load Control: <code>msg.shedding</code> = <code>shed</code>/<code>unshed</code> con la stessa frequenza del <b>Poll (ms)</b> (oppure solo al cambio stato se abiliti <i>Solo se cambia</i>).</li>
	    <li><b>Stato connessione</b>: quando cambia lo stato del dispositivo, invia un messaggio con <code>msg.topic = alfasinapsi/telemetry/status</code> e <code>msg.status</code>.</li>
	  </ul>

  <h3>msg.status (stato connessione)</h3>
  <p>Ogni messaggio emesso include <code>msg.status</code>, con:</p>
  <ul>
    <li><code>status.connected</code> (boolean)</li>
    <li><code>status.connecting</code> (boolean)</li>
    <li><code>status.error</code> (string|null)</li>
    <li><code>status.ts</code> (number, epoch ms)</li>
  </ul>

  <h3>Output: Telemetria</h3>
  <dl class="message-properties">
    <dt>msg.topic <span class="property-type">string</span></dt>
    <dd><code>alfasinapsi/telemetry</code></dd>

    <dt>msg.payload <span class="property-type">object</span></dt>
    <dd>Valori semplificati per l'uso quotidiano (potenza/energia/fascia tariffaria/avviso distacco).</dd>

    <dt>msg.insight <span class="property-type">object</span></dt>
    <dd>Dettagli tecnici (telemetria completa decodificata + meta informazioni).</dd>
  </dl>

  <h3>msg.payload (semplificato)</h3>
  <ul>
    <li><code>payload.power.importkW</code>, <code>payload.power.exportkW</code>, <code>payload.power.productionkW</code></li>
    <li><code>payload.energy.importTotalkWh</code>, <code>payload.energy.exportTotalkWh</code>, <code>payload.energy.productionTotalkWh</code></li>
    <li><code>payload.tariffBand</code></li>
    <li><code>payload.cutoff.hasWarning</code>, <code>payload.cutoff.remainingSeconds</code>, <code>payload.cutoff.atIso</code></li>
    <li><code>payload.messageAtIso</code>, <code>payload.meterReadAtIso</code></li>
  </ul>

  <h3>Terminologia</h3>
  <ul>
    <li><b>Import</b>: potenza/energia prelevata dalla rete (consumi piu di quanto produci).</li>
    <li><b>Export</b>: potenza/energia immessa in rete (produci piu di quanto consumi).</li>
    <li><b>Production</b>: potenza/energia prodotta (per esempio da fotovoltaico).</li>
  </ul>

  <h3>msg.insight (tecnico)</h3>
  <ul>
    <li><code>insight.telemetry</code>: telemetria completa decodificata (include campi extra come fasce di ieri, medie di quarto d'ora, ecc.)</li>
    <li><code>insight.meta</code>: timestamp, codice funzione, modalita lettura</li>
    <li><code>insight.device</code>: dettagli profilo connessione</li>
  </ul>

	  <h3>Output: KNX Load Control PIN</h3>
	  <p>
	    Invia <code>shed</code> se la telemetria segnala un distacco imminente, altrimenti <code>unshed</code>.
	    La frequenza dei messaggi dipende da <b>Poll (ms)</b>. Se abiliti <i>Solo se cambia</i>, emette solo quando passa da <code>shed</code> a <code>unshed</code> (o viceversa).
	  </p>
	  <dl class="message-properties">
	    <dt>msg.topic <span class="property-type">string</span></dt>
	    <dd><code>alfasinapsi/telemetry/knx-load-control-pin</code></dd>

    <dt>msg.payload <span class="property-type">string</span></dt>
    <dd><code>shed</code> oppure <code>unshed</code></dd>

    <dt>msg.shedding <span class="property-type">string</span></dt>
    <dd><code>shed</code> oppure <code>unshed</code> (per compatibilita con KNX Load Control)</dd>
  </dl>

	  <h3>Configurazione</h3>
	  <dl class="message-properties">
    <dt>Dispositivo <span class="property-type">alfasinapsi-device</span></dt>
    <dd>Indirizzo IP Sinapsi (impostazioni di comunicazione fisse).</dd>

	    <dt>Poll (ms) <span class="property-type">number</span></dt>
	    <dd>
	      Ogni quanto il nodo legge i dati e (in modalita <code>Telemetria</code>) ogni quanto puo emettere messaggi.
	      Se colleghi l'output a logiche di shedding a stadi, questo valore influenza la velocita della sequenza.
	    </dd>

    <dt>Solo se cambia <span class="property-type">boolean</span></dt>
    <dd>Se abilitato, invia messaggi solo quando cambia il payload.</dd>

	    <dt>Compatibilita <span class="property-type">telemetry | knxLoadControlPin</span></dt>
	    <dd>
	      <ul>
	        <li><code>Telemetria</code>: emette la telemetria (rispetta <i>Poll</i> e <i>Solo se cambia</i>).</li>
	        <li><code>KNX Load Control PIN</code>: emette <code>shed</code>/<code>unshed</code> (rispetta <i>Poll</i> e <i>Solo se cambia</i>).</li>
	      </ul>
	      Nota: se colleghi l'output al nodo <code>alfasinapsi-load-controller</code>, un <i>Poll</i> piu basso rende la sequenza di shedding piu veloce (stage che cambia di 1 per messaggio).
	    </dd>
	  </dl>

  <h3>Dettagli tecnici</h3>
  <ul>
    <li>Codice funzione: <code>3</code> (lettura registri holding)</li>
  </ul>

  <h3>Risoluzione problemi</h3>
  <ul>
    <li>Se i valori restano a 0, verifica l'indirizzo IP e che la porta 502 sia raggiungibile da Node-RED.</li>
    <li>Se vedi errori di timeout, assicurati che nessun altro sistema sia connesso al dispositivo nello stesso momento (spesso e' consentita una sola connessione alla volta).</li>
  </ul>
</script>

<script type="text/javascript">
  (function () {
    RED.nodes.registerType('alfasinapsi-telemetry', {
      category: 'AlfaSinapsi Ultimate',
      color: '#00BAFF',
      defaults: {
        name: { value: "" },
        device: { value: "", type: "alfasinapsi-device", required: true },
        pollInterval: { value: 10000, validate: RED.validators.number() },
        sendOnChange: { value: false },
        compatibility: { value: "telemetry" }
      },
      inputs: 0,
      outputs: 1,
      outputLabels: function () {
        return (this.compatibility === "knxLoadControlPin") ? "KNX Load Control PIN" : "telemetria";
      },
      icon: "font-awesome/fa-bolt",
      label: function () { return this.name || "alfasinapsi telemetria"; }
    });
  })();
</script>
